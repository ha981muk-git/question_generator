{% extends "base.html" %}
{% block title %}Question Paper{% endblock %}
{% block content %}
<div class="px-4 sm:px-0 max-w-5xl mx-auto">
    <!-- Header Section -->
    <div class="mb-6 no-print">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center">
                <div class="p-3 bg-gray-800 rounded-lg shadow mr-4">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                        </path>
                    </svg>
                </div>
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Question Paper</h1>
                    <p class="text-gray-600 mt-1">Generated question paper ready for use</p>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="copyAllQuestions()"
                    class="flex items-center px-5 py-3 bg-gray-800 text-white rounded-lg hover:bg-gray-900 transition-all duration-200 shadow hover:shadow-lg">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z">
                        </path>
                    </svg>
                    Copy All
                </button>
                <button onclick="window.print()"
                    class="hidden md:flex items-center px-5 py-3 bg-white border-2 border-gray-300 text-gray-700 rounded-lg hover:border-gray-400 hover:bg-gray-50 transition-all duration-200 shadow-sm">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z">
                        </path>
                    </svg>
                    Print
                </button>
            </div>
        </div>
    </div>

    <!-- Paper Info Card -->
    <div class="bg-white border-2 border-gray-800 shadow-lg mb-8" style="font-family: 'Times New Roman', Times, serif;">
        <!-- Header -->
        <div class="border-b-2 border-gray-800 px-8 py-6 bg-gray-50">
            <div class="text-center mb-4">
                <h2 class="text-2xl font-bold text-gray-900 uppercase tracking-wide">Question Paper</h2>
            </div>
            <div class="grid grid-cols-3 gap-8 text-base">
                <div>
                    <span class="font-bold">Subject:</span> <span class="ml-2">{{ subject }}</span>
                </div>
                <div class="text-center">
                    <span class="font-bold">Class:</span> <span class="ml-2">{{ class_name }}</span>
                </div>
                <div class="text-right">
                    <span class="font-bold">Total Marks:</span> <span class="ml-2">{{ total_marks }}</span>
                </div>
            </div>
        </div>

        <!-- Question Sections -->
        <div class="p-8 space-y-8" id="question-paper-content">
            {% set qno = 1 %}

            <!-- Fill in the Blanks -->
            {% if questions["Fill in the Blanks"] %}
            <div class="border-2 border-gray-300 p-6" data-section="fill-blanks">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-900">
                        {{ qno }}. Fill in the Blanks
                        <span class="font-normal">[{{ counts["Fill in the Blanks"] }} × {{ marks["Fill in the Blanks"]
                            or 1 }} = {{ counts["Fill in the Blanks"] * (marks["Fill in the Blanks"] or 1) }}
                            marks]</span>
                    </h3>
                    <button onclick="copySection('fill-blanks')"
                        class="no-print px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 rounded transition-colors">
                        Copy
                    </button>
                </div>

                {% if fill_options %}
                <div class="mb-4 p-3 bg-gray-50 border border-gray-300">
                    <p class="font-semibold mb-2">Word Bank:</p>
                    <p>[{{ fill_options | join(', ') }}]</p>
                </div>
                {% endif %}

                <ol class="space-y-2 ml-6 alphabetical-list">
                    {% for question in questions["Fill in the Blanks"] %}
                    <li class="leading-relaxed">{{ question }}</li>
                    {% endfor %}
                </ol>
            </div>
            {% set qno = qno + 1 %}
            {% endif %}

            <!-- Choose the Best Answer Section -->
            {% if questions["Choose the Best Answer"] %}
            {% set choose_count = counts["Choose the Best Answer"] %}
            {% set choose_mark = marks["Choose the Best Answer"] %}
            {% set choose_total = choose_count * choose_mark %}
            <div class="border-2 border-gray-300 p-6" data-section="choose-answer">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-900">
                        {{ qno }}. Choose the Best Answer
                        <span class="font-normal">[{{ choose_count }} × {{ choose_mark }} = {{ choose_total }}
                            marks]</span>
                    </h3>
                    <button onclick="copySection('choose-answer')"
                        class="no-print px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 rounded transition-colors">
                        Copy
                    </button>
                </div>

                <ol class="space-y-4 ml-6 alphabetical-list">
                    {% for q in questions["Choose the Best Answer"] %}
                    <li class="leading-relaxed">
                        <div class="mb-2">{{ q.question }}</div>
                        <div class="ml-4 options-single-line">
                            <span>a. {{ q.options[0] }}</span>
                            <span class="ml-6">b. {{ q.options[1] }}</span>
                            <span class="ml-6">c. {{ q.options[2] }}</span>
                            <span class="ml-6">d. {{ q.options[3] }}</span>
                        </div>
                    </li>
                    {% endfor %}
                </ol>
            </div>
            {% set qno = qno + 1 %}
            {% endif %}

            <!-- True/False -->
            {% if questions["True/False"] %}
            <div class="border-2 border-gray-300 p-6" data-section="true-false">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-900">
                        {{ qno }}. True/False
                        <span class="font-normal">[{{ counts["True/False"] }} × {{ marks["True/False"] or 1 }} = {{
                            counts["True/False"] * (marks["True/False"] or 1) }} marks]</span>
                    </h3>
                    <button onclick="copySection('true-false')"
                        class="no-print px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 rounded transition-colors">
                        Copy
                    </button>
                </div>

                <ol class="space-y-2 ml-6 alphabetical-list">
                    {% for q in questions["True/False"] %}
                    <li class="leading-relaxed">{{ q }}</li>
                    {% endfor %}
                </ol>
            </div>
            {% set qno = qno + 1 %}
            {% endif %}

            <!-- Match the Following -->
            {% if questions["Match the Following"] %}
            <div class="border-2 border-gray-300 p-6" data-section="match-following">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-900">
                        {{ qno }}. Match the Following
                        <span class="font-normal">[{{ counts["Match the Following"] }} × {{ marks["Match the Following"]
                            or 1 }} = {{ counts["Match the Following"] * (marks["Match the Following"] or 1) }}
                            marks]</span>
                    </h3>
                    <button onclick="copySection('match-following')"
                        class="no-print px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 rounded transition-colors">
                        Copy
                    </button>
                </div>

                <table class="w-full border-collapse border-2 border-gray-400">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="border-2 border-gray-400 px-4 py-2 text-left font-bold">Column A</th>
                            <th class="border-2 border-gray-400 px-4 py-2 text-left font-bold">Column B</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for left, right in questions["Match the Following"] %}
                        <tr>
                            <td class="border-2 border-gray-400 px-4 py-2">{{ left }}</td>
                            <td class="border-2 border-gray-400 px-4 py-2">{{ right }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% set qno = qno + 1 %}
            {% endif %}

            <!-- Full Form -->
            {% if questions["Full Form"] %}
            <div class="border-2 border-gray-300 p-6" data-section="full-form">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-900">
                        {{ qno }}. Full Form
                        <span class="font-normal">[{{ counts["Full Form"] }} × {{ marks["Full Form"] or 1 }} = {{
                            counts["Full Form"] * (marks["Full Form"] or 1) }} marks]</span>
                    </h3>
                    <button onclick="copySection('full-form')"
                        class="no-print px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 rounded transition-colors">
                        Copy
                    </button>
                </div>

                <ol class="space-y-2 ml-6 alphabetical-list">
                    {% for abbr in questions["Full Form"] %}
                    <li class="leading-relaxed">{{ abbr }}</li>
                    {% endfor %}
                </ol>
            </div>
            {% set qno = qno + 1 %}
            {% endif %}

            <!-- One Word Answer -->
            {% if questions["One Word Answer"] %}
            <div class="border-2 border-gray-300 p-6" data-section="one-word">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-900">
                        {{ qno }}. One Word Answer
                        <span class="font-normal">[{{ counts["One Word Answer"] }} × {{ marks["One Word Answer"] or 1 }}
                            = {{ counts["One Word Answer"] * (marks["One Word Answer"] or 1) }} marks]</span>
                    </h3>
                    <button onclick="copySection('one-word')"
                        class="no-print px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 rounded transition-colors">
                        Copy
                    </button>
                </div>

                <ol class="space-y-2 ml-6 alphabetical-list">
                    {% for q in questions["One Word Answer"] %}
                    <li class="leading-relaxed">{{ q }}</li>
                    {% endfor %}
                </ol>
            </div>
            {% set qno = qno + 1 %}
            {% endif %}

            <!-- Short Answer -->
            {% if questions["Short Answer"] %}
            <div class="border-2 border-gray-300 p-6" data-section="short-answer">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-900">
                        {{ qno }}. Short Answer
                        <span class="font-normal">[{{ counts["Short Answer"] }} × {{ marks["Short Answer"] or 2 }} = {{
                            counts["Short Answer"] * (marks["Short Answer"] or 2) }} marks]</span>
                    </h3>
                    <button onclick="copySection('short-answer')"
                        class="no-print px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 rounded transition-colors">
                        Copy
                    </button>
                </div>

                <ol class="space-y-2 ml-6 alphabetical-list">
                    {% for q in questions["Short Answer"] %}
                    <li class="leading-relaxed">{{ q }}</li>
                    {% endfor %}
                </ol>
            </div>
            {% set qno = qno + 1 %}
            {% endif %}

            <!-- Long Answer -->
            {% if questions["Long Answer"] %}
            <div class="border-2 border-gray-300 p-6" data-section="long-answer">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-900">
                        {{ qno }}. Long Answer
                        <span class="font-normal">[{{ counts["Long Answer"] }} × {{ marks["Long Answer"] or 5 }} = {{
                            counts["Long Answer"] * (marks["Long Answer"] or 5) }} marks]</span>
                    </h3>
                    <button onclick="copySection('long-answer')"
                        class="no-print px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 rounded transition-colors">
                        Copy
                    </button>
                </div>
                <ol class="space-y-2 ml-6 alphabetical-list">
                    {% for q in questions["Long Answer"] %}
                    <li class="leading-relaxed">{{ q }}</li>
                    {% endfor %}
                </ol>
            </div>
            {% set qno = qno + 1 %}
            {% endif %}

            <!-- Answer the Following -->
            {% if questions["Answer the Following"] %}
            {% set answer_count = counts["Answer the Following"] %}
            {% set answer_mark = marks["Answer the Following"] %}
            {% set answer_total = answer_count * answer_mark %}
            <div class="border-2 border-gray-300 p-6" data-section="answer-following">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-900">
                        {{ qno }}. Answer the Following
                        <span class="font-normal">[{{ answer_count }} × {{ answer_mark }} = {{ answer_total }}
                            marks]</span>
                    </h3>
                    <button onclick="copySection('answer-following')"
                        class="no-print px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 rounded transition-colors">
                        Copy
                    </button>
                </div>

                <ol class="space-y-2 ml-6 alphabetical-list">
                    {% for q in questions["Answer the Following"] %}
                    <li class="leading-relaxed">{{ q }}</li>
                    {% endfor %}
                </ol>
            </div>
            {% set qno = qno + 1 %}
            {% endif %}

            <!-- Manual Questions Section -->
            {% if questions["Manual Questions"] %}
            <div class="border-2 border-gray-300 p-6" data-section="manual-questions">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-lg font-bold text-gray-900">
                        {{ qno }}. {{ question_type }}
                        <span class="font-normal">[{{ counts["Manual Questions"] }} × {{ marks["Manual Questions"] or 5
                            }} = {{ counts["Manual Questions"] * (marks["Manual Questions"] or 5) }} marks]</span>
                    </h3>
                    <button onclick="copySection('manual-questions')"
                        class="no-print px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 rounded transition-colors">
                        Copy
                    </button>
                </div>

                <!-- Numbered List Format -->
                {% if output_format == "numbered" %}
                <div class="space-y-1 ml-4">
                    {% for q in questions["Manual Questions"] %}
                    <div class="leading-relaxed">{{ loop.index }}. {{ q }}</div>
                    {% endfor %}
                </div>

                <!-- Paragraph Format -->
                {% else %}
                <div class="whitespace-pre-line ml-4">{{ questions["Manual Questions"][0] }}</div>
                {% endif %}
            </div>
            {% set qno = qno + 1 %}
            {% endif %}
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex flex-col sm:flex-row gap-4 mb-8 no-print">
        <button onclick="window.print()"
            class="flex-1 md:hidden inline-flex items-center justify-center px-6 py-4 bg-gray-800 text-white rounded-lg hover:bg-gray-900 transition-all duration-200 shadow hover:shadow-lg">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z">
                </path>
            </svg>
            Print Paper
        </button>
        <button onclick="window.location.reload()"
            class="flex-1 inline-flex items-center justify-center px-6 py-4 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg hover:from-blue-700 hover:to-purple-700 transition-all duration-200 shadow hover:shadow-lg">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                </path>
            </svg>
            Generate New Paper
        </button>
       
    </div>
</div>

<!-- Toast Notification -->
<div id="toast"
    class="no-print fixed top-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 ease-in-out z-50">
    <div class="flex items-center">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
        <span id="toast-message">Copied to clipboard!</span>
    </div>
</div>

<!-- JavaScript for Copy Functionality -->
<script>
    function showToast(message) {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        toastMessage.textContent = message;
        toast.style.transform = 'translateX(0)';

        setTimeout(() => {
            toast.style.transform = 'translateX(150%)';
        }, 2000);
    }

    function copyAllQuestions() {
        const content = document.getElementById('question-paper-content');
        const clonedContent = content.cloneNode(true);

        // Remove all copy buttons from cloned content
        const buttons = clonedContent.querySelectorAll('button');
        buttons.forEach(btn => btn.remove());

        const text = clonedContent.innerText;

        navigator.clipboard.writeText(text).then(() => {
            showToast('All questions copied to clipboard!');
        }).catch(err => {
            console.error('Failed to copy:', err);
            showToast('Failed to copy');
        });
    }

    function copySection(sectionId) {
        const section = document.querySelector(`[data-section="${sectionId}"]`);
        const clonedSection = section.cloneNode(true);

        // Remove the copy button from cloned content
        const button = clonedSection.querySelector('button');
        if (button) button.remove();

        const text = clonedSection.innerText;

        navigator.clipboard.writeText(text).then(() => {
            showToast('Section copied to clipboard!');
        }).catch(err => {
            console.error('Failed to copy:', err);
            showToast('Failed to copy');
        });
    }
</script>

<!-- Print Styles -->
<style>
    body {
        font-family: 'Times New Roman', Times, serif;
    }

    /* Alphabetical numbering for lists */
    .alphabetical-list {
        list-style-type: none;
        counter-reset: alphabet-counter;
    }

    .alphabetical-list li {
        counter-increment: alphabet-counter;
        position: relative;
        padding-left: 1.5rem;
    }

    .alphabetical-list li::before {
        content: counter(alphabet-counter, lower-alpha) ". ";
        position: absolute;
        left: 0;
        font-weight: normal;
    }

    /* Single line options for MCQ */
    .options-single-line {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
        align-items: center;
    }

    @media print {
        body {
            background: white;
        }

        .no-print {
            display: none !important;
        }

        .border-2 {
            border-width: 2px;
            border-color: #000 !important;
        }

        .bg-gray-50 {
            background: #f9f9f9 !important;
        }

        @page {
            margin: 1cm;
        }

        /* Ensure alphabetical numbering works in print */
        .alphabetical-list li::before {
            content: counter(alphabet-counter, lower-alpha) ". ";
        }

        /* Single line options for print */
        .options-single-line {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
        }

        /* Single line options for MCQ */
        .options-single-line {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            align-items: center;
        }
    }
</style>
{% endblock %}